<script>
    if (!map) {
        var bounds = L.latLngBounds([[90, -70], [-90, 310]]);

        var map = L.map('map', {
            maxZoom: 18,
            minZoom: 3,
            dragging: true,
            maxBounds: bounds,
            zoomSnap: 0.5,
            center: [8.345422, 158.581226],
            zoom: 3
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a ></a> K.Y.L.C',
            language: 'en',
        }).addTo(map);
    }


    // Function to add markers to the map
    function addMarkers(locations) {
        locations.forEach(function (location) {
            var pointIcon = L.divIcon({
                className: 'point-icon', // CSS class for styling
                html: '<div class="point-marker"></div>', // HTML for the point symbol
                iconAnchor: [3, 3], // Center the marker at the coordinates

            });

            L.marker([location.longitude, location.latitude], { icon: pointIcon }).addTo(map).bindPopup(location.pointName);
        });
    }

    // Fetch locations from Google Sheets and add markers
    google.script.run.withSuccessHandler(addMarkers).getSJCLocations();

    function addPolylines(cables) {
        // Fetch cable names from Google Sheets using Google Apps Script
        google.script.run.withSuccessHandler(function (data) {
            if (!Array.isArray(data.combinedCableNamesStart) || !Array.isArray(data.combinedCableNames)) {
                console.error('Invalid data format for combinedCableNames:', data.combinedCableNamesStart);
                return;
            }

            // Function to determine if a cable name matches
            function isMatch(cableName, combinedName) {
                var combinedNameUpperCase = combinedName.toUpperCase();
                var parts = combinedNameUpperCase.split(' ');
                var cableType = parts[0];

                if (parts.length === 0 || parts.length <= 1) return false;

                //checking each parts
                for (var i = 1; i < parts.length; i++) {
                    var part = parts[i];
                    var concatenate = cableType.concat(" ", part);
                    if (cableName === concatenate) {
                        return true;
                    }
                }
                return false;


                // var [firstPart, secondPart = '', thirdPart = '', fourthPart = ''] = parts;

                // function checkPart(part, cableNamePart, firstPart) {
                //   console.log("this is the part "+part)
                //     if(isNaN(part)){
                //       return false;
                //     }
                //     return cableNamePart.includes(part);
                // }

                // return cableName.includes(firstPart) &&
                //     checkPart(secondPart, cableName, firstPart) &&
                //     checkPart(thirdPart, cableName, firstPart) &&
                //     checkPart(fourthPart, cableName, firstPart);
            }

            function determineColor(cableName) {
                if (data.combinedCableNamesStart.some(combinedNamestart => isMatch(cableName, combinedNamestart))) {
                    return 'red';
                }
                if (data.combinedCableNames.some(combinedName => isMatch(cableName, combinedName))) {
                    return 'yellow';
                }
                return 'green';
            }

            cables.forEach(function (cable) {
                var latitudeFrom = parseFloat(cable.latitudeFrom);
                var longitudeFrom = parseFloat(cable.longitudeFrom);
                var latitudeTo = parseFloat(cable.latitudeTo);
                var longitudeTo = parseFloat(cable.longitudeTo);
                var cableName = cable.cableName.toUpperCase(); // Convert cable name to uppercase for case-insensitive comparison

                // Check if parsed values are valid numbers
                if (isNaN(latitudeFrom) || isNaN(longitudeFrom) || isNaN(latitudeTo) || isNaN(longitudeTo)) {
                    return; // Skip this cable if coordinates are invalid
                }

                var coordinates = [
                    [longitudeFrom, latitudeFrom],
                    [longitudeTo, latitudeTo]
                ];

                // Determine color based on matches
                var color = determineColor(cableName);

                // Add polyline to the map
                L.polyline(coordinates, { color: color, weight: 2 }).addTo(map).bindPopup(cable.cableName);
            });
        }).getCableNames(); // Call the getCableNames function in your Google Apps Script
    }


    // testing for SEAUS connections

    function changePolylineColor(rangeIndex) {
        let stringDate = document.getElementById(parseInt(rangeIndex) + 1).value;
        let notifiedCableConnetions = [];
        let cableData;
        let notifiedCoordinates;


        function changeColor(data, coordinates) {


            data.forEach(cable => {

                let color;

                if (parseDate(stringDate) >= parseDate(cable.startDate) && parseDate(stringDate) <= parseDate(cable.endDate)) {
                    color = 'red';
                } else if (parseDate(stringDate) < parseDate(cable.startDate)) {
                    color = 'yellow';
                } else if (parseDate(stringDate) > parseDate(cable.endDate)) {
                    color = 'green';
                }

                let tempName = "SEAUS " + cable.cableName;

                let tempCoordinates = coordinates.filter(row => {
                    row.cableName === tempName
                })

                var storeCoordinates = [
                    [tempCoordinates.longitudeFrom, tempCoordinates.latitudeFrom],
                    [tempCoordinates.longitudeTo, tempCoordinates.latitudeTo]
                ];

                L.polyline(storeCoordinates, { color: color, weight: 2 }).addTo(map).bindPopup(tempName);
            })
        }


        function parseDate(dateStr) {
            return new Date(dateStr);
        }


        // Function to process cable data and set up the notifiedCableConnetions array
        function getCableData(data) {
            // Populate cableData
            cableData = data.map(([cableSystem, notifiedDate, startDate, endDate, segment1, segment2, segment3]) => ({
                cableSystem,
                notifiedDate,
                startDate,
                endDate,
                segment1,
                segment2,
                segment3
            }));

            // Populate notifiedCableConnetions based on the cable data
            notifiedCableConnetions = cableData.map(({ segment1 }) =>
                'SEAUS ' + segment1.toUpperCase()
            );

            // After processing cable data, call the function to get coordinates
            google.script.run.withSuccessHandler(getCoordinates).getSJCData();
        }

        // Function to process coordinates data based on notifiedCableConnetions
        function getCoordinates(cables) {
            // Filter cables based on SEAUS and notifiedCableConnetions
            const filteredCableSystem = cables.filter(row =>
                row.cableSystem === 'SEAUS' && notifiedCableConnetions.includes(row.cableName)
            );

            // Map filtered cables to get notifiedCoordinates
            notifiedCoordinates = filteredCableSystem.map(row => ({
                cableName: row.cableName,
                latitudeFrom: row.latitudeFrom,
                longitudeFrom: row.longitudeFrom,
                latitudeTo: row.latitudeTo,
                longitudeTo: row.longitudeTo
            }));

            changeColor(cableData, notifiedCoordinates);

        }

        // Start the process by getting cable data
        google.script.run.withSuccessHandler(getCableData).extractDates();
    }



    function initializeMap() {
        google.script.run.withSuccessHandler(addMarkers).getSJCLocations();
        google.script.run.withSuccessHandler(addPolylines).getSJCData();
    }

    // Call the initializeMap function when the page loads
    window.onload = initializeMap;

    // Function to update map data every 30 seconds
    function updateMapData() {
        google.script.run.withSuccessHandler(addMarkers).getSJCLocations();
        google.script.run.withSuccessHandler(addPolylines).getSJCData();
    }

    updateMapData();

    // Function to search for a cable system and filter the cables accordingly
    function searchCableSystem() {
        $('#spinnerModal').modal('show');
        var searchTerm = document.getElementById("search-input").value; // Convert search term to uppercase for case-insensitive comparison

        // Check if search term is not empty
        if (searchTerm === "Show All Cable Systems") {


            google.script.run.withSuccessHandler(addMarkers).getSJCLocations();
            google.script.run.withSuccessHandler(addPolylines).getSJCData();

            // Set the opacity of all cables to 0.2
            setAllCablesOpacity(1);
            $('#spinnerModal').modal('hide');

        } else if (searchTerm !== "") {
            // Update map data based on the search term
            google.script.run.withSuccessHandler(addMarkers).getSJCLocationsByCableSystem(searchTerm);
            google.script.run.withSuccessHandler(addPolylines).getSJCDataByCableSystem(searchTerm);

            // Set the opacity of all cables to 0.2
            setAllCablesOpacity(0.01);
            $('#spinnerModal').modal('hide');
        }
    }

    // Function to set the opacity of all cables on the map
    function setAllCablesOpacity(opacity) {
        map.eachLayer(function (layer) {
            if (layer instanceof L.Polyline) {
                layer.setStyle({ opacity: opacity });
            }
        });
    }


</script>
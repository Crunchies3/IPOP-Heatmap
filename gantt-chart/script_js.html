<script type="text/javascript">
    //disabling user interaction in ganttchart
    gantt.config.drag_resize = false;
    gantt.config.drag_progress = false;
    gantt.config.drag_links = false;
    gantt.config.readonly = true;


    gantt.config.scale_height = 75;
    gantt.config.min_column_width = 40;

    gantt.config.start_on_monday = false;
    gantt.config.scales = [
        { unit: "week", step: 1, format: "%j %F %Y" },
        { unit: "day", step: 1, format: "%j" },
        {
            unit: "day",
            step: 1,
            format: function (date) {
                const dayAbbreviations = ["S", "M", "T", "W", "T", "F", "S"];
                return dayAbbreviations[date.getDay()];
            }
        }
    ];

    gantt.config.columns = [
        { name: "text", label: "CABLE SYSTEMS", width: "125", tree: true },
        { name: "start_date", label: "START", width: "100" },
        { name: "duration", label: "DAYS", width: "100" },
        { name: "end_date", label: "END", width: "100" },
        { name: "incidentType", hide: true }

    ];
    gantt.plugins({
        fullscreen: true,
        tooltip: true,
        marker: true
    });

    // Adding current date marker
    function addCurrentDateMarker() {
        var today = new Date();
        gantt.addMarker({
            start_date: today, // the current date
            css: "today-marker", // a CSS class applied to the marker
            text: "Today", // the label text
        });
    }

    // Call the function to add the current date marker
    addCurrentDateMarker();



    //modifying header styles
    gantt.templates.grid_header_class = function (columnName, column) {
        return "updColorHeaderTitle";

    };

    gantt.templates.task_text = function (start, end, task) {
        return task.incidentType;
    };





    //fetching datas
    function addToChart(affectedCables) {
        var dataLength = Object.keys(data.tasks).length;
        affectedCables.combinedCableNames.forEach(cables => {
            dataLength++;
            var currentDate = new Date();
            var startD;
            var endDate = cables.endDate;
            var parentId;
            var splitted = cables.combinedName.trim().split(" ");
            var cableType = splitted[0];
            var colored;
            var incidentType = cables.incidentType;
            var progressed;



            if (cableType === 'SJC') {
                parentId = 1;
            } else if (cableType === 'SEAUS') {
                parentId = 2;
            } else if (cableType === 'TGN') {
                parentId = 3;
            } else {
                parentId = 4;
            }

            if (incidentType === "Planned Activity") {
                colored = "#ef6c00";
            } else if (incidentType === "Partial Outage") {
                colored = "#37474f";
            }
            else {
                colored = "#FF0000";
            }

            //parsing dates for progress bar automation to work (yyyy-mm-dd)
            startD = new Date(cables.startDate);
            endDate = new Date(endDate);

            //automating the progress-bar (dark)
            if (currentDate < startD) {
                progressed = 0;
            } else if (currentDate >= endDate) {
                progressed = 1;
            } else {
                var totalDuration = endDate - startD;
                var elapsedDuration = currentDate - startD;
                progressed = Math.min(1, elapsedDuration / totalDuration);
            }


            //parsing dates for the gantt chart to work (dd-mm-yyyy)
            startD = formatDate(new Date(startD));
            endDate = formatDate(new Date(endDate));

            data.tasks.push({
                id: dataLength,
                text: cables.combinedName.trim(),
                start_date: startD,
                end_date: endDate,
                parent: parentId,
                color: colored,
                incidentType: cables.incidentType,
                progress: progressed
            });

        });

        gantt.parse(data);

    }

    function formatDate(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-based
        const year = date.getFullYear();

        return `${day}-${month}-${year}`;
    }


    //date format DD-MM-YYYY
    var data = {
        tasks: [
            { id: 1, text: "SJC", color: "#522258", incidentType: "SJC", unscheduled: true, open: true },
            { id: 2, text: "SEAUS", color: "#1A4D2E", incidentType: "SEAUS", unscheduled: true, open: true },
            { id: 3, text: "TGN", color: "#8B322C", incidentType: "TGN", unscheduled: true, open: true },
            { id: 4, text: "C2C/EAC", color: "#A0153E", incidentType: "C2C/EAC", unscheduled: true, open: true }
        ]

    };

    google.script.run.withSuccessHandler(addToChart).getCableNames();
    gantt.init("gantt_here");

</script>
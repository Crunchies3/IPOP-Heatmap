<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
  <!-- Alert container goes here -->
</div>

<div>
  <h1>Add New Ticket</h1>
</div>
<span class="close-btn" onclick="openAddPanel()"><i class="fa fa-times" aria-hidden="true"></i></span>
<form class="custom-modal-width">
  <div class="row">
    <hr>
    <div class="form-group col-md-6">
      <label for="inputTroubleTicket" class="form-label ">Trouble Ticket:</label>
      <input type="text" class="form-control" id="inputTroubleTicket" required>
      <div class="invalid-feedback">
        Please enter a trouble ticket.
      </div>
    </div>

    <div class="form-group col-md-6">
      <label for="cableSystemSelect" class="form-label">Cable System:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="cableSystemSelect"
        style="margin-bottom:10px;" required>
        <option value="" disabled selected>Select Cable System</option>
        <option value="C2C">C2C</option>
        <option value="EAC">EAC</option>
        <option value="TGN">TGN-IA/TGN-P</option>
        <option value="SEAUS">SEA-US</option>
        <option value="SJC">SJC</option>
      </select>
      <div class="invalid-feedback">
        Please select a cable system.
      </div>
    </div>
  </div>
  <br>
  <div class="row">
    <hr>
    <div class="form-group col-md-4">
      <label for="inputNotificationDateTime" class="form-label">Notification Date and Time:</label>
      <input type="datetime-local" class="form-control" id="inputNotificationDateTime" name="inputNotificationDateTime"
        style="margin-bottom: 10px;" required>
      <div class="invalid-feedback">
        Please select date and time
      </div>
    </div>

    <div class="form-group col-md-4">
      <label for="inputStartDateTimeUTC" class="form-label">Start Date and Time (UTC):</label>
      <input type="datetime-local" class="form-control" id="inputStartDateTimeUTC" name="inputStartDateTimeUTC"
        style="margin-bottom: 10px;" required>
      <div class="invalid-feedback">
        Please select start date and time
      </div>
    </div>

    <div class="form-group col-md-4">
      <label for="inputEndDateTimeUTC" class="form-label">End Date and Time (UTC):</label>
      <input type="datetime-local" class="form-control" id="inputEndDateTimeUTC" style="margin-bottom: 10px;" required>
      <div class="invalid-feedback">
        Please select end date and time
      </div>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-md-3" style="display: none;">
      <label for="inputOutageDuration" class="form-label">Outage Duration:</label>
      <input type="text" class="form-control" id="inputOutageDuration" readonly>
    </div>

    <div class="form-group col-md-3" style="display: none;">
      <label for="inputActivityImpactDuration" class="form-label">Activity Impact Duration:</label>
      <input type="text" class="form-control" id="inputActivityImpactDuration" readonly>
    </div>

    <div class="form-group col-md-6">
      <label for="inputImpact" class="form-label">Impact:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputImpact"
        style="margin-bottom:10px;" required>
        <option value="" disabled selected>Select Impact</option>
        <option value="2-5 Bearers">2-5 Bearers</option>
        <option value="6-10 Bearers">6-10 Bearers</option>
        <option value="11 and More">11 and More</option>
        <option value="All Bearers">All Bearers</option>
      </select>
      <div class="invalid-feedback">
        Please select an impact level.
      </div>
    </div>

    <div class="form-group col-md-6">
      <label for="inputIncidentType" class="form-label">Incident Type:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputIncidentType"
        style="margin-bottom:10px;" required>
        <option value="" disabled selected>Select Incident Type</option>
        <option value="Outage">Outage</option>
        <option value="Planned Activity">Planned Activity</option>
      </select>
      <div class="invalid-feedback">
        Please select an incident type.
      </div>
    </div>
  </div>
  <br>
  <div class="row">
    <hr>
    <div class="form-group col-md-4">
      <label for="inputAffectedSegment1" class="form-label">Affected Segment 1:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputAffectedSegment1"
        style="margin-bottom: 10px;">
        <option value="">Select a Segment</option>
        <!-- Options will be populated dynamically using JavaScript -->
      </select>
      <div class="invalid-feedback">
        Please select at least 1 segment.
      </div>
    </div>

    <div class="form-group col-md-4">
      <label for="inputAffectedSegment2" class="form-label">Affected Segment 2:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputAffectedSegment2"
        style="margin-bottom: 10px;">
        <option value="">Select a Segment</option>
        <!-- Options will be populated dynamically using JavaScript -->
      </select>
    </div>

    <div class="form-group col-md-4">
      <label for="inputAffectedSegment3" class="form-label">Affected Segment 3:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputAffectedSegment3"
        style="margin-bottom: 10px;">
        <option value="">Select a Segment</option>
        <!-- Options will be populated dynamically using JavaScript -->
      </select>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-md-4">
      <label for="inputLocation" class="form-label">Location:</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputLocation"
        style="margin-bottom:10px;" required>
        <option value="" disabled selected>Select Location</option>
        <option value="Terrestial/Dry Segment">Terrestial/Dry Segment</option>
        <option value="Wet Segment">Wet Segment</option>
        <option value="Undetermined">Undetermined</option>
        <option value="Backhaul">Backhaul</option>
      </select>
      <div class="invalid-feedback">
        Please select a location.
      </div>
    </div>

    <div class="form-group col-md-4">
      <label for="inputRootCauseH" class="form-label">Root Cause (High Level):</label>
      <select class="form-select form-control p-1" aria-label="Default select example" id="inputRootCauseH"
        style="margin-bottom: 10px;" required>
        <option value="" disabled selected>Select Root Cause</option>
        <option value="BMH Issue">BMH Issue</option>
        <option value="Cable Fault">Cable Fault</option>
        <option value="Card Failure">Card Failure</option>
        <option value="Configuration Issue">Configuration Issue</option>
        <option value="Fan Issue">Fan Issue</option>
        <option value="Force Majeure">Force Majeure</option>
        <option value="Government/Private Project">Government/Private Project</option>
        <option value="Human Error">Human Error</option>
        <option value="PFE Issue">PFE Issue</option>
        <option value="Physical Connection">Physical Connection</option>
        <option value="Planned Maintenance">Planned Maintenance</option>
        <option value="Shunt Fault">Shunt Fault</option>
        <option value="Subsea Equipment Fault">Subsea Equipment Fault</option>
        <option value="Unknown">Unknown</option>
      </select>
      <div class="invalid-feedback">
        Please select a root cause.
      </div>
    </div>

    <div class="form-group col-md-4">
      <label for="inputRootCauseSpecificInternal" class="form-label">Root Cause (Specific-Internal):</label>
      <textarea class="form-control" id="inputRootCauseSpecificInternal"></textarea>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-md-6">
      <label for="inputAdditionalRemarks" class="form-label">Additional Remarks (Internal):</label>
      <textarea class="form-control" id="inputAdditionalRemarks"></textarea>
    </div>

    <div class="form-group col-md-6">
      <label for="inputMonthYear" class="form-label">Month Year:</label>
      <input type="month" class="form-control" id="inputMonthYear" min="2023-01" readonly>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-md-12 text-end">
      <br>
      <button type="button" class="btn btn-primary" onclick="AddRow()" style="width:170px;">Add</button>
    </div>
  </div>
</form>

<script>
  function showGoogleScriptAlert(message, type) {
    var alertColorClass;
    switch (type) {
      case 'success':
        alertColorClass = 'alert-success';
        break;
      case 'error':
        alertColorClass = 'alert-danger';
        break;
      default:
        alertColorClass = 'alert-warning';
    }

    var alertHtml = `
    <div class="alert ${alertColorClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

    $('#alertContainer').prepend(alertHtml);
  }

  // Add To Sheets
  function AddRow() {
    // Get the values from input fields
    var troubleTicket = document.getElementById("inputTroubleTicket").value.trim();
    var cableSystem = document.getElementById("cableSystemSelect").value;
    var notificationDateTime = document.getElementById("inputNotificationDateTime").value;
    var startDateTimeUTC = document.getElementById("inputStartDateTimeUTC").value;
    var endDateTimeUTC = document.getElementById("inputEndDateTimeUTC").value;
    var outageDuration = document.getElementById("inputOutageDuration").value;
    var affectedSegment1 = document.getElementById("inputAffectedSegment1").value;
    var location = document.getElementById("inputLocation").value;
    var activityImpactDuration = document.getElementById("inputActivityImpactDuration").value;
    var affectedSegment2 = document.getElementById("inputAffectedSegment2").value;
    var rootCauseH = document.getElementById("inputRootCauseH").value;
    var impact = document.getElementById("inputImpact").value;
    var affectedSegment3 = document.getElementById("inputAffectedSegment3").value;
    var incidentType = document.getElementById("inputIncidentType").value;
    var rootCauseSpecificInternal = document.getElementById("inputRootCauseSpecificInternal").value;
    var additionalRemarks = document.getElementById("inputAdditionalRemarks").value;
    var monthYear = document.getElementById("inputMonthYear").value;

    // Clear previous invalid feedback
    document.querySelectorAll('.is-invalid').forEach(function (el) {
      el.classList.remove('is-invalid');
    });

    // Validate required fields
    var hasError = false;

    if (!troubleTicket) {
      document.getElementById("inputTroubleTicket").classList.add("is-invalid");
      hasError = true;
    }

    if (!cableSystem) {
      document.getElementById("cableSystemSelect").classList.add("is-invalid");
      hasError = true;
    }

    if (!notificationDateTime && document.getElementById('inputIncidentType').value != "Outage") {
      document.getElementById("inputNotificationDateTime").classList.add("is-invalid");
      hasError = true;
    }

    if (!affectedSegment1) {
      document.getElementById("inputAffectedSegment1").classList.add("is-invalid");
      hasError = true;
    }

    if (!location) {
      document.getElementById("inputLocation").classList.add("is-invalid");
      hasError = true;
    }

    // Check for other fields only if they are visible
    if (document.getElementById("inputStartDateTimeUTC").style.display !== 'none' && !startDateTimeUTC) {
      document.getElementById("inputStartDateTimeUTC").classList.add("is-invalid");
      hasError = true;
    }

    if (document.getElementById("inputEndDateTimeUTC").style.display !== 'none' && !endDateTimeUTC) {
      document.getElementById("inputEndDateTimeUTC").classList.add("is-invalid");
      hasError = true;
    }

    if (hasError) {
      return;
    }

    $('#spinnerModal').modal('show');

    // Proceed if no errors
    google.script.run.withSuccessHandler(function (ticketExists) {
      if (ticketExists) {
        $('#spinnerModal').modal('hide');
        showGoogleScriptAlert('Trouble ticket already exists.', 'warning');
      } else {
        // $('#spinnerModal').modal('show');

        var majorIncidents = [
          troubleTicket, cableSystem, notificationDateTime, startDateTimeUTC, endDateTimeUTC, outageDuration, activityImpactDuration, impact, incidentType, affectedSegment1, affectedSegment2, affectedSegment3, location, rootCauseH, rootCauseSpecificInternal, additionalRemarks, monthYear
        ];

        google.script.run.withSuccessHandler(function (response) {
          console.log('Data added to the sheet');
          Clear();
          $('#spinnerModal').modal('hide');
          showGoogleScriptAlert(troubleTicket + ' added successfully. Refresh the page.', 'success');
        }).addDataToSheetMI('MAJOR INCIDENTS', majorIncidents);

        google.script.run.withSuccessHandler(function (response) {
          console.log('Data added to the sheet');
          Clear();
        }).addDataToSheetNotif('Notifications', majorIncidents);

        console.log('Adding==================================')
        google.script.run.withSuccessHandler().addToActivityLog('Add', troubleTicket, incidentType);

        google.script.run.withSuccessHandler(function (url) {
          window.open(url, '_top');
        }).getScriptUrl();
      }
    }).checkTroubleTicketExistence(troubleTicket);
  }

  function Clear() {
    document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
    document.querySelectorAll('textarea').forEach(el => el.value = '');
    document.querySelectorAll('select').forEach(el => el.value = '');
  }
</script>

<script>
  function populateNames(nameSelectId) {
    var cableSystem = document.getElementById("cableSystemSelect").value;
    var nameSelect = document.getElementById(nameSelectId);
    nameSelect.innerHTML = '<option value="">Select Name</option>';
    if (window.sampleData) {
      window.sampleData.forEach(function (item) {
        if (item.cableSystem === cableSystem) {
          var option = document.createElement("option");
          option.value = item.value;
          option.textContent = item.name;
          nameSelect.appendChild(option);
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("cableSystemSelect").addEventListener("change", function () {
      populateNames("inputAffectedSegment1");
      populateNames("inputAffectedSegment2");
      populateNames("inputAffectedSegment3");
    });

    google.script.run.withSuccessHandler(function (data) {
      window.sampleData = data;
      populateNames("inputAffectedSegment1");
      populateNames("inputAffectedSegment2");
      populateNames("inputAffectedSegment3");
    }).getSampleData();
  });


  //disabling the dates if the incident type chosen is outage (red automatic)
  document.addEventListener('DOMContentLoaded', function () {
    const incidentType = document.getElementById('inputIncidentType');
    const disabling = document.querySelectorAll('#inputNotificationDateTime,#inputStartDateTimeUTC')

    incidentType.addEventListener('change', function () {
      if (this.value === "Outage") {
        disabling.forEach(input => {
          input.disabled = true;
          var dateTime = document.getElementById('inputStartDateTimeUTC');
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');

          const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
          dateTime.value = formattedDateTime;
        });
      } else {
        disabling.forEach(input => {
          input.disabled = false;
        });
      }
    });
  });
</script>
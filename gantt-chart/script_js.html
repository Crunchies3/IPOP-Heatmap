<script type="text/javascript">
    //disabling user interaction in ganttchart
    gantt.config.drag_resize = false;
    gantt.config.drag_progress = false;
    gantt.config.drag_links = false;
    gantt.config.readonly = true;


    gantt.config.scale_height = 75;
    gantt.config.min_column_width = 40

    gantt.config.scales = [
        { unit: "month", step: 1, format: "%F, %Y" },
        { unit: "day", step: 1, format: "%j" }
    ];

    gantt.config.columns = [
        { name: "text", label: "Cable Systems", tree: true, width: "*" },
        { name: "notif_date", hide: true },
        { name: "end_date", hide: true },
        { name: "incidentType", hide: true }

    ];
    gantt.plugins({
        fullscreen: true
    });

    gantt.templates.grid_header_class = function (columnName, column) {
        if (columnName == "text") {
            return "updColorHeaderTitle";
        }
    };

    gantt.templates.task_text = function (start, end, task) {
        return task.incidentType;
    };



    //fetching datas
    function addToChart(affectedCables) {
        console.log(affectedCables.combinedCableNames);
        var dataLength = Object.keys(data.tasks).length;
        affectedCables.combinedCableNames.forEach(cables => {
            dataLength++;
            var startD;
            var notifD;
            var currentDate = new Date();
            var endDate = cables.endDate;
            var parentId;
            var splitted = cables.combinedName.trim().split(" ");
            var cableType = splitted[0];
            var colored;
            var incidentType = cables.incidentType;
            var progressed;


            if (cables.notifiedDate != null) {
                startD = cables.notifiedDate;
                notifD = "";
            } else {
                startD = cables.startDate;
                notifD = cables.notifiedDate;
            }

            if (cableType === 'SJC') {
                parentId = 1;
            } else if (cableType === 'SEAUS') {
                parentId = 2;
            } else if (cableType === 'TGN') {
                parentId = 3;
            } else {
                parentId = 4;
            }

            if (incidentType === "Planned Activity") {
                colored = "#FFDE4D";
            } else {
                colored = "#FF0000"
            }

            //parsing dates for progress bar automation to work (yyyy-mm-dd)
            notifD = new Date(notifD);
            startD = new Date(startD);
            endDate = new Date(endDate);

            console.log(currentDate);
            console.log(endDate);
            //automating the progress-bar (dark)
            if (currentDate < startD) {
                console.log("hello")
                progressed = 0;
            } else if (currentDate >= endDate) {
                console.log("bay")
                progressed = 1;
            } else {
                console.log("ako ni")
                var totalDuration = endDate - startD;
                console.log(totalDuration);
                var elapsedDuration = currentDate - startD;
                console.log(elapsedDuration);
                progressed = Math.min(1, elapsedDuration / totalDuration);
                console.log(progressed);
            }

            //parsing dates for the gantt chart to work (dd-mm-yyyy)
            currentDate = formatDate(currentDate);
            notifD = formatDate(new Date(notifD));
            startD = formatDate(new Date(startD));
            endDate = formatDate(new Date(endDate));

            data.tasks.push({
                id: dataLength,
                text: cables.combinedName.trim(),
                notif_date: notifD,
                start_date: startD,
                end_date: endDate,
                parent: parentId,
                color: colored,
                incidentType: cables.incidentType,
                progress: progressed
            });
        });
        gantt.parse(data);

    }

    function formatDate(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-based
        const year = date.getFullYear();

        return `${day}-${month}-${year}`;
    }


    //date format DD-MM-YYYY
    var data = {
        tasks: [
            { id: 1, text: "SJC", duration: 0, color: "#522258", incidentType: "=========SJC=========" },
            { id: 2, text: "SEAUS", duration: 0, color: "#1A4D2E", incidentType: "=========SEAUS=========" },
            { id: 3, text: "TGN", duration: 0, color: "#8B322C", incidentType: "=========TGN=========" },
            { id: 4, text: "C2C/EAC", duration: 0, color: "#A0153E", incidentType: "=========C2C/EAC=========" }
        ]

    };


    google.script.run.withSuccessHandler(addToChart).getCableNames();
    gantt.init("gantt_here");

</script>
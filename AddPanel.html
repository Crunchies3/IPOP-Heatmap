<!-- <div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
</div> -->

<style>
  #adding_ticket label {
    font-size: 13px;
  }
</style>

<div class="modal fade" id="addTicketModal" data-bs-backdrop="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add new ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="adding_ticket">
          <div class="row">
            <div class="form-group col-md-6">
              <label for="inputTroubleTicket">Trouble Ticket <span class="importantField">*</span></label>
              <input type="text" class="form-control" id="inputTroubleTicket">
            </div>
            <div class="form-group col-md-6">
              <label for="cableSystemSelect">Cable System <span class="importantField">*</span></label>
              <select class=" form-select" aria-label="Default select example" style="margin-bottom:10px;"
                id="cableSystemSelect">
                <option value="C2C">C2C</option>
                <option value="EAC">EAC</option>
                <option value="TGN">TGN-IA/TGN-P</option>
                <option value="SEAUS">SEA-US</option>
                <option value="SJC">SJC</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-4">
              <label for="inputNotificationDateTime">Notification Date and Time <span
                  class="importantField">*</span></label>
              <input required type="datetime-local" class="form-control" id="inputNotificationDateTime"
                style="margin-bottom: 10px;">
            </div>
            <div class="form-group col-md-4">
              <label for="inputStartDateTimeUTC">Start Date and Time (UTC)</label>
              <input type="datetime-local" class="form-control" id="inputStartDateTimeUTC" style="margin-bottom: 10px;">
            </div>
            <div class="form-group col-md-4">
              <label for="inputEndDateTimeUTC">End Date and Time (UTC)</label>
              <input type="datetime-local" class="form-control" id="inputEndDateTimeUTC" style="margin-bottom: 10px;">
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-3" style="display: none;">
              <label for="inputOutageDuration">Outage Duration</label>
              <input type="text" class="form-control" id="inputOutageDuration" readonly>
            </div>
            <div class="form-group col-md-3" style="display: none;">
              <label for="inputActivityImpactDuration">Activity Impact Duration</label>
              <input type="text" class="form-control" id="inputActivityImpactDuration" readonly>
            </div>
            <div class="form-group col-md-6">
              <label for="inputImpact">Impact <span class="importantField">*</span></label>
              <select class=" form-select" aria-label="Default select example" style="margin-bottom:10px;"
                id="inputImpact">
                <option selected> </option>
                <option value="2-5 Bearers">2-5 Bearers</option>
                <option value="6-10 Bearers">6-10 Bearers</option>
                <option value="11 and More">11 and More</option>
                <option value="All Bearers">All Bearers</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="inputIncidentType">Incident Type <span class="importantField">*</span></label>
              <select class=" form-select" aria-label="Default select example" style="margin-bottom:10px;"
                id="inputIncidentType">
                <option selected> </option>
                <option value="Outage">Outage</option>
                <option value="Planned Activity">Planned Activity</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-4">
              <label for="inputAffectedSegment1">Affected Segment 1 <span class="importantField">*</span></label>
              <select class="form-select" aria-label="Default select example" style="margin-bottom: 10px;"
                id="inputAffectedSegment1">
                <option value="">Select Name</option>
                <!-- Options will be populated dynamically using JavaScript -->
              </select>
            </div>
            <!-- Name Dropdown 2 -->
            <div class="form-group col-md-4">
              <label for="inputAffectedSegment2">Affected Segment 2</label>
              <select class="form-select" aria-label="Default select example" style="margin-bottom: 10px;"
                id="inputAffectedSegment2">
                <option value="">Select Name</option>
                <!-- Options will be populated dynamically using JavaScript -->
              </select>
            </div>
            <!-- Name Dropdown 3 -->
            <div class="form-group col-md-4">
              <label for="inputAffectedSegment3">Affected Segment 3</label>
              <select class="form-select" aria-label="Default select example" style="margin-bottom: 10px;"
                id="inputAffectedSegment3">
                <option value="">Select Name</option>
                <!-- Options will be populated dynamically using JavaScript -->
              </select>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-4">
              <label for="inputLocation">Location</label>
              <select class=" form-select" aria-label="Default select example" style="margin-bottom:10px;"
                id="inputLocation">
                <option selected> </option>
                <option value="Terrestial/Dry Segment">Terrestial/Dry Segment</option>
                <option value="Wet Segment">Wet Segment</option>
                <option value="Undetermined">Undetermined</option>
                <option value="Backhaul">Backhaul</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label for="inputRootCauseH">Root Cause (High Level)</label>
              <select class="form-select" aria-label="Default select example" style="margin-bottom: 10px;"
                id="inputRootCauseH">
                <option selected></option>
                <option value="BMH Issue">BMH Issue</option>
                <option value="Cable Fault">Cable Fault</option>
                <option value="Card Failure">Card Failure</option>
                <option value="Configuration Issue">Configuration Issue</option>
                <option value="Fan Issue">Fan Issue</option>
                <option value="Force Majeure">Force Majeure</option>
                <option value="Government/Private Project">Government/Private Project</option>
                <option value="Human Error">Human Error</option>
                <option value="PFE Issue">PFE Issue</option>
                <option value="Physical Connection">Physical Connection</option>
                <option value="Planned Maintenance">Planned Maintenance</option>
                <option value="Shunt Fault">Shunt Fault</option>
                <option value="Subsea Equipment Fault">Subsea Equipment Fault</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label for="inputRootCauseSpecificInternal">Root Cause (Specific-Internal):</label>
              <textarea class="form-control" id="inputRootCauseSpecificInternal"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="inputAdditionalRemarks">Additional Remarks (Internal)</label>
              <textarea class="form-control" id="inputAdditionalRemarks"></textarea>
            </div>
            <div class="form-group col-md-6">
              <label for="inputMonthYear">Month Year</label>
              <input type="month" class="form-control" id="inputMonthYear" min="2023-01" readonly>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="AddRow()" style="width:170px;">Add</button>
      </div>
    </div>
  </div>
</div>


<script>
  function showGoogleScriptAlert(message, type) {
    var alertColorClass;
    switch (type) {
      case 'success':
        alertColorClass = 'alert-success';
        break;
      case 'error':
        alertColorClass = 'alert-danger';
        break;
      default:
        alertColorClass = 'alert-warning';
    }

    var alertHtml = `
      <div class="alert ${alertColorClass} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;

    $('#alertContainer').prepend(alertHtml);
  }

  //Add To Sheets
  function AddRow() {
    // Get values from input fields
    var troubleTicket = document.getElementById("inputTroubleTicket").value;
    var cableSystem = document.getElementById("cableSystemSelect").value;
    var notificationDateTime = document.getElementById("inputNotificationDateTime").value;
    var startDateTimeUTC = document.getElementById("inputStartDateTimeUTC").value;
    var endDateTimeUTC = document.getElementById("inputEndDateTimeUTC").value;
    var outageDuration = document.getElementById("inputOutageDuration").value;
    var affectedSegment1 = document.getElementById("inputAffectedSegment1").value;
    var location = document.getElementById("inputLocation").value;
    var activityImpactDuration = document.getElementById("inputActivityImpactDuration").value;
    var affectedSegment2 = document.getElementById("inputAffectedSegment2").value;
    var rootCauseH = document.getElementById("inputRootCauseH").value;
    var impact = document.getElementById("inputImpact").value;
    var affectedSegment3 = document.getElementById("inputAffectedSegment3").value;
    var incidentType = document.getElementById("inputIncidentType").value;
    var rootCauseSpecificInternal = document.getElementById("inputRootCauseSpecificInternal").value;
    var additionalRemarks = document.getElementById("inputAdditionalRemarks").value;
    var monthYear = document.getElementById("inputMonthYear").value;

    // Check if required fields are empty
    if (!troubleTicket || !cableSystem || !notificationDateTime || !impact || !incidentType || !affectedSegment1) {
      showGoogleScriptAlert('Please fill in trouble ticket and cable system.', 'error');
      return;
    }

    // Check if trouble ticket already exists in the sheet
    google.script.run.withSuccessHandler(function (ticketExists) {
      if (ticketExists) {
        showGoogleScriptAlert('Trouble ticket already exists.', 'warning');
      } else {
        $('#spinnerModal').modal('show');

        // Create an array with the collected data
        var majorIncidents = [
          troubleTicket, cableSystem, notificationDateTime, startDateTimeUTC, endDateTimeUTC, outageDuration, activityImpactDuration, impact, incidentType, affectedSegment1, affectedSegment2, affectedSegment3, location, rootCauseH, rootCauseSpecificInternal, additionalRemarks, monthYear
        ];

        // Call the server-side function to add data to the sheet
        google.script.run.withSuccessHandler(function (response) {
          // Optionally, you can handle the response or perform additional actions
          console.log('Data added to the sheet');

          // Clear input fields
          Clear();

          // Show success alert
          $('#spinnerModal').modal('hide');
          showGoogleScriptAlert(troubleTicket + ' added successfully. Refresh the page.', 'success');
        }).addDataToSheetMI('MAJOR INCIDENTS', majorIncidents);

        google.script.run.withSuccessHandler(function (response) {
          // Optionally, you can handle the response or perform additional actions
          console.log('Data added to the sheet');

          // Clear input fields
          Clear();
        }).addDataToSheetNotif('Notifications', majorIncidents);
      }
    }).checkTroubleTicketExistence(troubleTicket);
  }


  function Clear() {
    $('input[type="text"]').val('');
  }

</script>

<script>
  // Function to populate name dropdown based on selected cable system
  function populateNames(nameSelectId) {
    var cableSystem = document.getElementById("cableSystemSelect").value;
    var nameSelect = document.getElementById(nameSelectId);
    nameSelect.innerHTML = '<option value="">Select Name</option>'; // Clear previous options
    if (window.sampleData) {
      window.sampleData.forEach(function (item) {
        if (item.cableSystem === cableSystem) {
          var option = document.createElement("option");
          option.value = item.value;
          option.textContent = item.name;
          nameSelect.appendChild(option);
        }
      });
    }
  }

  // Event listener for cable system selection change
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("cableSystemSelect").addEventListener("change", function () {
      populateNames("inputAffectedSegment1"); // Update the first name dropdown when cable system changes
      populateNames("inputAffectedSegment2"); // Update the second name dropdown when cable system changes
      populateNames("inputAffectedSegment3"); // Update the third name dropdown when cable system changes
    });

    // Fetch sample data from Google Apps Script and populate the name dropdowns
    google.script.run.withSuccessHandler(function (data) {
      window.sampleData = data; // Define sampleData as a global variable
      populateNames("inputAffectedSegment1"); // Populate the first name dropdown initially
      populateNames("inputAffectedSegment2"); // Populate the second name dropdown initially
      populateNames("inputAffectedSegment3"); // Populate the third name dropdown initially
    }).getSampleData();
  });
</script>